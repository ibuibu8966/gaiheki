# フェーズ1: データベースセットアップ

## 概要

このフェーズでは、新しい請求管理機能に必要なデータベーステーブルを追加します。

## プロジェクト情報

- **GitHubリポジトリ**: https://github.com/ibuibu8966/gaiheki
- **ブランチ**: `admin-dashboard-complete`
- **データベース**: PostgreSQL (Supabase)

## タスク

### 1. Prismaスキーマの更新

`prisma/schema.prisma` ファイルに以下の変更を加えてください。

#### 1.1 既存テーブルへのカラム追加

**`orders` テーブル**に以下のカラムを追加：
```prisma
customer_invoice_id Int?                   @unique
customer_invoices   customer_invoices?     @relation(fields: [customer_invoice_id], references: [id])
```

**`partners` テーブル**に以下のカラムとリレーションを追加：
```prisma
fee_plan_id       Int?
fee_plans         fee_plans?           @relation(fields: [fee_plan_id], references: [id])
company_invoices  company_invoices[]
```

#### 1.2 新規Enumの追加

```prisma
enum InvoiceStatus {
  DRAFT     // 下書き
  UNPAID    // 未払い
  PAID      // 支払い済み
  OVERDUE   // 支払い遅延
  CANCELLED // キャンセル
}
```

#### 1.3 新規テーブルの追加

**`customer_invoices` テーブル** (加盟店→顧客への請求書)
```prisma
model customer_invoices {
  id              Int                        @id @default(autoincrement())
  invoice_number  String                     @unique @db.VarChar(50)
  order_id        Int                        @unique
  issue_date      DateTime                   @db.Date
  due_date        DateTime                   @db.Date
  total_amount    Int
  tax_amount      Int
  grand_total     Int
  status          InvoiceStatus              @default(UNPAID)
  payment_date    DateTime?                  @db.Date
  created_at      DateTime                   @default(now())
  updated_at      DateTime                   @updatedAt

  order           orders                     @relation(fields: [order_id], references: [id])
  invoice_items   customer_invoice_items[]
}
```

**`customer_invoice_items` テーブル** (請求書明細)
```prisma
model customer_invoice_items {
  id          Int      @id @default(autoincrement())
  invoice_id  Int
  description String   @db.VarChar(255)
  quantity    Float
  unit        String   @db.VarChar(20)
  unit_price  Int
  amount      Int
  created_at  DateTime @default(now())

  invoice     customer_invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}
```

**`fee_plans` テーブル** (料金プラン)
```prisma
model fee_plans {
  id              Int        @id @default(autoincrement())
  name            String     @db.VarChar(100)
  monthly_fee     Int?
  per_order_fee   Int?
  per_project_fee Int?
  project_fee_rate Float?
  is_default      Boolean    @default(false)
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  partners        partners[]
}
```

**`company_invoices` テーブル** (運営→加盟店への請求書)
```prisma
model company_invoices {
  id                   Int                      @id @default(autoincrement())
  invoice_number       String                   @unique @db.VarChar(50)
  partner_id           Int
  issue_date           DateTime                 @db.Date
  due_date             DateTime                 @db.Date
  billing_period_start DateTime                 @db.Date
  billing_period_end   DateTime                 @db.Date
  total_amount         Int
  tax_amount           Int
  grand_total          Int
  status               InvoiceStatus            @default(UNPAID)
  payment_date         DateTime?                @db.Date
  created_at           DateTime                 @default(now())
  updated_at           DateTime                 @updatedAt

  partner              partners                 @relation(fields: [partner_id], references: [id])
  invoice_items        company_invoice_items[]
}
```

**`company_invoice_items` テーブル** (請求書明細)
```prisma
model company_invoice_items {
  id               Int      @id @default(autoincrement())
  invoice_id       Int
  description      String   @db.VarChar(255)
  amount           Int
  related_order_id Int?
  created_at       DateTime @default(now())

  invoice          company_invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}
```

**`system_settings` テーブル** (システム設定)
```prisma
model system_settings {
  id            Int      @id @default(autoincrement())
  setting_key   String   @unique @db.VarChar(100)
  setting_value String   @db.VarChar(255)
  description   String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}
```

### 2. マイグレーションの実行

スキーマ更新後、以下のコマンドを実行してください：

```bash
npx prisma migrate dev --name add_billing_features
```

### 3. Seedデータの作成

`prisma/seed.ts` ファイルに以下の初期データを追加してください：

#### 3.1 デフォルト料金プラン

```typescript
// デフォルトの料金プラン
await prisma.fee_plans.create({
  data: {
    name: 'スタンダードプラン',
    monthly_fee: 30000,      // 月額30,000円
    per_order_fee: 5000,     // 受注1件につき5,000円
    per_project_fee: null,
    project_fee_rate: 0.05,  // 施工完了金額の5%
    is_default: true,
  },
});
```

#### 3.2 システム設定

```typescript
// 請求サイクル設定
await prisma.system_settings.createMany({
  data: [
    {
      setting_key: 'billing_cycle_closing_day',
      setting_value: '31',
      description: '請求締め日（月末）',
    },
    {
      setting_key: 'billing_cycle_payment_day',
      setting_value: '20',
      description: '支払期日（翌月20日）',
    },
    {
      setting_key: 'tax_rate',
      setting_value: '0.10',
      description: '消費税率（10%）',
    },
  ],
});
```

### 4. Seedの実行

```bash
npx prisma db seed
```

## 確認事項

マイグレーションとSeed実行後、以下を確認してください：

- [ ] すべてのテーブルが正常に作成されている
- [ ] `fee_plans` テーブルにデフォルトプランが1件登録されている
- [ ] `system_settings` テーブルに3件の設定が登録されている
- [ ] 既存データに影響がない

## 完了報告

このフェーズが完了したら、以下を報告してください：

1. マイグレーションファイル名
2. 作成されたテーブル一覧
3. Seed実行結果

次のフェーズに進む準備ができたら教えてください。

