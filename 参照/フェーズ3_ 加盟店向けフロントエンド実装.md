# フェーズ3: 加盟店向けフロントエンド実装

## 前提条件

- フェーズ2（加盟店向けバックエンドAPI）が完了していること
- すべてのAPIが正常に動作していること

## 概要

このフェーズでは、加盟店向けのダッシュボードと請求管理画面のフロントエンドを実装します。

## デザインガイドライン

- 既存のUIコンポーネント（Shadcn/UI）を使用
- 既存のデザインとトンマナを維持
- レスポンシブデザインを考慮

## タスク

### 1. ダッシュボード画面

#### 1.1 ページ作成

`app/partner-dashboard/page.tsx` を作成または更新してください。

#### 1.2 実装内容

**KPIサマリーカード**
- 問い合わせ件数、受注件数、施工完了件数、売上、未入金額を表示
- カード形式で4〜5個横並びに配置
- 前月比などの変化率も表示（オプション）

**月次売上推移グラフ**
- 過去12ヶ月の売上推移を棒グラフで表示
- `recharts` ライブラリを使用
- グラフにホバーすると詳細が表示される

**案件ステータス別件数グラフ**
- 問い合わせ、見積中、受注、施工中、施工完了の件数を円グラフで表示
- `recharts` ライブラリを使用

**期間絞り込み**
- セレクトボックスで「今月」「先月」「今年」「カスタム」を選択
- カスタムを選択した場合、日付ピッカーで期間を指定

#### 1.3 実装例

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

export default function PartnerDashboard() {
  const [period, setPeriod] = useState('current_month');
  const [dashboardData, setDashboardData] = useState(null);

  useEffect(() => {
    fetchDashboardData(period);
  }, [period]);

  const fetchDashboardData = async (period: string) => {
    const res = await fetch(`/api/partner/dashboard?period=${period}`);
    const data = await res.json();
    setDashboardData(data);
  };

  if (!dashboardData) return <div>読み込み中...</div>;

  return (
    <div className="p-6 space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold">ダッシュボード</h1>
        <Select value={period} onValueChange={setPeriod}>
          <SelectTrigger className="w-[180px]">
            <SelectValue placeholder="期間を選択" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="current_month">今月</SelectItem>
            <SelectItem value="last_month">先月</SelectItem>
            <SelectItem value="current_year">今年</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* KPIサマリーカード */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <Card>
          <CardHeader>
            <CardTitle className="text-sm">問い合わせ件数</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">{dashboardData.kpi.inquiries}</p>
          </CardContent>
        </Card>
        {/* 他のKPIカードも同様に実装 */}
      </div>

      {/* グラフエリア */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>月次売上推移</CardTitle>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={dashboardData.revenue_trend}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="month" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="revenue" fill="#8884d8" />
              </BarChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>案件ステータス別件数</CardTitle>
          </CardHeader>
          <CardContent>
            {/* 円グラフを実装 */}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

### 2. 請求管理画面

#### 2.1 ページ作成

`app/partner-dashboard/invoices/page.tsx` を作成してください。

#### 2.2 実装内容

**請求書一覧テーブル**
- 請求書番号、顧客名、案件名、請求額、発行日、支払期日、ステータスを表示
- ステータスでフィルタリング
- キーワード検索
- ページネーション

**アクションボタン**
- 「新規作成」ボタン（右上）
- 各行に「詳細」「PDF出力」ボタン

**ステータスバッジ**
- `DRAFT`: グレー
- `UNPAID`: オレンジ
- `PAID`: グリーン
- `OVERDUE`: レッド

#### 2.3 実装例

```tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

export default function InvoiceList() {
  const router = useRouter();
  const [invoices, setInvoices] = useState([]);
  const [status, setStatus] = useState('all');
  const [search, setSearch] = useState('');

  useEffect(() => {
    fetchInvoices();
  }, [status, search]);

  const fetchInvoices = async () => {
    const params = new URLSearchParams();
    if (status !== 'all') params.append('status', status);
    if (search) params.append('search', search);
    
    const res = await fetch(`/api/partner/invoices?${params}`);
    const data = await res.json();
    setInvoices(data.invoices);
  };

  const getStatusBadge = (status: string) => {
    const variants = {
      DRAFT: 'secondary',
      UNPAID: 'warning',
      PAID: 'success',
      OVERDUE: 'destructive',
    };
    return <Badge variant={variants[status]}>{status}</Badge>;
  };

  return (
    <div className="p-6 space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold">請求管理</h1>
        <Button onClick={() => router.push('/partner-dashboard/invoices/new')}>
          新規作成
        </Button>
      </div>

      <div className="flex gap-4">
        <Input
          placeholder="顧客名、案件名で検索"
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="max-w-sm"
        />
        <Select value={status} onValueChange={setStatus}>
          <SelectTrigger className="w-[180px]">
            <SelectValue placeholder="ステータス" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">すべて</SelectItem>
            <SelectItem value="DRAFT">下書き</SelectItem>
            <SelectItem value="UNPAID">未払い</SelectItem>
            <SelectItem value="PAID">支払い済み</SelectItem>
            <SelectItem value="OVERDUE">遅延</SelectItem>
          </SelectContent>
        </Select>
      </div>

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>請求書番号</TableHead>
            <TableHead>顧客名</TableHead>
            <TableHead>案件名</TableHead>
            <TableHead>請求額</TableHead>
            <TableHead>発行日</TableHead>
            <TableHead>支払期日</TableHead>
            <TableHead>ステータス</TableHead>
            <TableHead>操作</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {invoices.map((invoice) => (
            <TableRow key={invoice.id}>
              <TableCell>{invoice.invoice_number}</TableCell>
              <TableCell>{invoice.customer_name}</TableCell>
              <TableCell>{invoice.project_name}</TableCell>
              <TableCell>¥{invoice.grand_total.toLocaleString()}</TableCell>
              <TableCell>{invoice.issue_date}</TableCell>
              <TableCell>{invoice.due_date}</TableCell>
              <TableCell>{getStatusBadge(invoice.status)}</TableCell>
              <TableCell>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => router.push(`/partner-dashboard/invoices/${invoice.id}`)}
                >
                  詳細
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
```

### 3. 請求書作成・詳細画面

#### 3.1 ページ作成

- `app/partner-dashboard/invoices/new/page.tsx` (新規作成)
- `app/partner-dashboard/invoices/[id]/page.tsx` (詳細・編集)

#### 3.2 実装内容

**基本情報入力**
- 案件選択（施工完了案件のみ）
- 発行日、支払期日

**請求項目入力**
- 品目、数量、単位、単価を入力
- 「項目を追加」ボタンで動的に行を追加
- 各行に「削除」ボタン

**金額計算**
- 小計、消費税、合計を自動計算
- リアルタイムで更新

**アクションボタン**
- 「下書き保存」
- 「発行」（ステータスをUNPAIDに変更）
- 「PDF出力」
- 「入金確認」（ステータスをPAIDに変更）

#### 3.3 PDF出力機能

`jspdf` または `react-pdf` を使用して、請求書をPDF形式で出力する機能を実装してください。

**PDF内容:**
- 請求書番号
- 発行日
- 支払期日
- 顧客情報（名前、住所）
- 加盟店情報（会社名、住所、電話番号）
- 請求項目一覧（品目、数量、単位、単価、金額）
- 小計、消費税、合計

## 必要なライブラリ

以下のライブラリをインストールしてください：

```bash
npm install recharts jspdf
# または
npm install recharts @react-pdf/renderer
```

## テスト

以下のシナリオをテストしてください：

- [ ] ダッシュボードが正しく表示される
- [ ] 期間絞り込みが動作する
- [ ] グラフが正しく表示される
- [ ] 請求書一覧が表示される
- [ ] ステータスフィルタが動作する
- [ ] 検索機能が動作する
- [ ] 請求書を新規作成できる
- [ ] 請求項目を追加・削除できる
- [ ] 金額が自動計算される
- [ ] 請求書を編集できる（下書きのみ）
- [ ] 請求書を発行できる
- [ ] 入金確認ができる
- [ ] PDFを出力できる

## 完了報告

このフェーズが完了したら、以下を報告してください：

1. 実装した画面一覧
2. スクリーンショット
3. テスト結果
4. 発生した問題と解決方法

次のフェーズに進む準備ができたら教えてください。

