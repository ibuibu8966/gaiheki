# 外壁塗装マッチングサイト - ダッシュボード機能追加プロジェクト

## プロジェクト概要

本プロジェクトは、外壁塗装のマッチングプラットフォームに対し、加盟店と運営会社向けの財務管理・請求管理機能を追加するものです。これにより、加盟店は自身の売上や利益を可視化し、顧客への請求書をシステム内で発行・管理できるようになります。また、運営会社は全加盟店の活動状況を把握し、プラットフォーム手数料の請求を効率的に行えるようになります。

## ビジネスモデル

本プラットフォームのビジネスフローは以下の通りです。

![ビジネスフロー図](https://private-us-east-1.manuscdn.com/sessionFile/b8YgRoIOvjS672LWGQVpxe/sandbox/RqJFc1kKXE0wobndYYE9hH-images_1760609152210_na1fn_L2hvbWUvdWJ1bnR1L2J1c2luZXNzX2Zsb3c.png?Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9wcml2YXRlLXVzLWVhc3QtMS5tYW51c2Nkbi5jb20vc2Vzc2lvbkZpbGUvYjhZZ1JvSU92alM2NzJMV0dRVnB4ZS9zYW5kYm94L1JxSkZjMWtLWEUwd29ibmRZWUU5aEgtaW1hZ2VzXzE3NjA2MDkxNTIyMTBfbmExZm5fTDJodmJXVXZkV0oxYm5SMUwySjFjMmx1WlhOelgyWnNiM2MucG5nIiwiQ29uZGl0aW9uIjp7IkRhdGVMZXNzVGhhbiI6eyJBV1M6RXBvY2hUaW1lIjoxNzk4NzYxNjAwfX19XX0_&Key-Pair-Id=K2HSFNDJXOU9YS&Signature=GULKY3OqlvLdqEtxc3bMEXjOJCaW3~Bn9PtsJ-7E7qDmmrb5oNiTXEZT3qf8jKf38ZC23nPMkfe-Y~RcXpD4u3AhwrCRbzNxpdecivNpC1QMt8MdaXcrgCSu3aCbWXkERV6duD9ofNDrlQxzbH2LirHwrIGBqbmf9-LoNTK2WpPlp4sCkiP7N~M04304IrYbj6KrNKVdCR1uShnNuJn2b2gqm2O~lMaJUhZlzanNOEx6OWdRs1-Uhk0BFAlgZlqQnL~yORtM3bJ7HC3fZmo9IaqIRnX5nnBDOa-gRVGL~kGLN1bnBmxBPIwKTU48~mOJVOtliyAMEZg5B-QT06Wbzw__)

### 顧客から加盟店への支払いフロー

顧客がサイト上で診断依頼を行うと、複数の加盟店が見積もりを提出します。顧客は提出された見積もりを比較検討し、最適な加盟店を選択します。選択された加盟店は正式に受注し、施工を開始します。施工完了後、加盟店はシステム内で顧客向けの請求書を作成し、顧客に提示します。顧客は請求書に基づき、加盟店に対して直接支払いを行います。加盟店はシステム上で入金確認を行い、案件を完了させます。

### 運営会社から加盟店への請求フロー

運営会社は、加盟店がプラットフォームを利用することに対し、プラットフォーム手数料を徴収します。手数料体系は、月額固定料金、受注ごとの固定料金、施工完了ごとの固定料金または料率など、複数のパターンを組み合わせることができます。運営会社は月末に各加盟店の活動実績（受注件数、施工完了件数など）を集計し、料金プランに基づいて手数料を自動計算します。その後、運営会社は加盟店に対して手数料請求書を発行し、加盟店は指定された支払期日までに運営会社に手数料を支払います。

## 追加機能の詳細

### 加盟店向け機能

加盟店向けには、主に以下の機能を追加します。

**ダッシュボード機能**では、加盟店がログイン後すぐに自身のビジネス状況を把握できるよう、各種KPIをサマリー表示します。具体的には、今月の問い合わせ件数、受注件数、施工完了件数、売上（顧客への請求額合計）、未入金額（顧客からの未払い合計）を表示します。さらに、月次売上推移グラフや案件ステータス別件数の円グラフを配置し、視覚的にビジネスの状況を把握できるようにします。表示期間は、デフォルトで当月を表示し、先月、今年、指定期間での絞り込みも可能とします。

**請求管理機能**では、加盟店が顧客に対して発行する請求書を一元管理します。請求書一覧画面では、案件名、顧客名、請求額、発行日、支払期日、ステータス（下書き、未払い、支払い済み、遅延）を一覧表示し、ステータスやキーワードで検索・絞り込みができます。請求書作成画面では、施工完了案件を選択し、請求項目（品目、数量、単位、単価）を自由に編集できます。消費税は10%で自動計算され、作成した請求書はPDF形式でダウンロードできます。また、入金確認後は「入金済み」ボタンでステータスを手動更新でき、支払期日を過ぎた未払い請求書は自動で「支払い遅延」ステータスに変更されます。

### 運営会社向け機能

運営会社向けには、全加盟店の活動状況を俯瞰的に把握し、手数料請求を効率化するための機能を追加します。

**ダッシュボード機能**では、全加盟店の今月の総売上、今月のプラットフォーム手数料売上、今月の新規加盟店数、アクティブ加盟店数といった全体KPIをサマリー表示します。また、加盟店ごとの受注件数、売上、手数料を一覧表示し、月次での絞り込みが可能です。

**請求管理機能**では、運営会社が加盟店に対して発行するプラットフォーム手数料の請求書を管理します。請求書一覧画面では、加盟店名、請求額、発行日、支払期日、ステータスを一覧表示します。月末には、各加盟店の料金プランと当月の活動（受注件数、施工完了件数）に基づき、請求データを自動生成します。「ワンクリックで発行」ボタンを押すと、生成された請求データが確定し、請求書が作成されます（ステータスが「未払い」になります）。発行した請求書はPDF形式でダウンロードでき、入金確認後は手動でステータスを「支払い済み」に更新します。支払期日（設定画面で変更可能）を過ぎた請求書は自動で「支払い遅延」ステータスになり、アラート表示されます。

**設定機能**では、プラットフォーム手数料の料金プランを作成・編集できます。プランには「月額固定」「受注ごとの固定額」「施工完了ごとの固定額」「施工完了ごとの料率」を自由に組み合わせて設定でき、全加盟店に一律で適用されるデフォルトプランを設定します。また、請求の締め日と支払期日を設定できる請求サイクル設定機能も提供します（例：月末締め、翌月20日払い）。

## データベース設計

本プロジェクトでは、既存のデータベーススキーマに対し、以下の変更と追加を行います。

### 既存テーブルの変更

**`orders` テーブル**には、加盟店が顧客に発行する請求書を紐付けるため、`customer_invoice_id` カラムを追加します。

**`partners` テーブル**には、加盟店ごとの料金プランを管理するため、`fee_plan_id` カラムを追加します。

### 新規テーブルの追加

**`customer_invoices` テーブル**は、加盟店が顧客に対して発行する請求書を管理します。請求書番号、発行日、支払期日、合計金額、消費税額、総合計、ステータス（下書き、未払い、支払い済み、遅延、キャンセル）、入金日などを記録します。

**`customer_invoice_items` テーブル**は、顧客向け請求書の明細を管理します。品目、数量、単位、単価、金額を記録し、`customer_invoices` テーブルとリレーションを持ちます。

**`fee_plans` テーブル**は、運営会社が設定する加盟店向けの料金プランを管理します。プラン名、月額固定料金、受注ごとの固定料金、施工完了ごとの固定料金、施工完了ごとの料率、デフォルトプランフラグなどを記録します。

**`company_invoices` テーブル**は、運営会社が加盟店に対して発行するプラットフォーム手数料の請求書を管理します。請求書番号、発行日、支払期日、請求対象期間（開始・終了）、合計金額、消費税額、総合計、ステータス、入金日などを記録します。

**`company_invoice_items` テーブル**は、運営会社から加盟店への請求書の明細を管理します。品目（例：月額利用料、受注手数料）、金額、関連受注IDなどを記録し、`company_invoices` テーブルとリレーションを持ちます。

**`system_settings` テーブル**は、請求サイクルなどのシステム設定を管理します。設定キー、設定値、説明を記録します。

### Enumの追加

請求ステータスを管理するため、`InvoiceStatus` Enumを追加します。値は、`DRAFT`（下書き）、`UNPAID`（未払い）、`PAID`（支払い済み）、`OVERDUE`（支払い遅延）、`CANCELLED`（キャンセル）です。

詳細なテーブル定義は、添付の `database_design.md` を参照してください。

## 実装ガイド

本プロジェクトの実装にあたっては、以下のステップで進めることを推奨します。

### Step 1: データベースのセットアップ

まず、`prisma/schema.prisma` ファイルを `database_design.md` に基づいて更新します。既存テーブルへのカラム追加と、新規テーブルの追加を行います。次に、ターミナルで `npx prisma migrate dev --name add-billing-features` コマンドを実行し、データベーススキーマを更新します。最後に、新しく追加した `fee_plans` テーブルと `system_settings` テーブルに初期データを作成するSeed処理を追加します。

### Step 2: バックエンド (API) の実装

`functional_requirements.md` で定義された各機能を実現するためのAPIエンドポイントを実装します。加盟店向けには、ダッシュボードデータ取得API、請求書一覧・作成・更新・ステータス変更APIを実装します。運営会社向けには、ダッシュボードデータ取得API、手数料請求書一覧・自動生成・発行・ステータス変更API、料金プラン管理API、システム設定管理APIを実装します。

### Step 3: フロントエンド (UI) の実装

既存のUIコンポーネント（Shadcn/UI）とデザインのトンマナを維持しながら、加盟店向けと運営会社向けの画面を実装します。加盟店向けには、ダッシュボード画面、請求管理画面、請求書作成・詳細画面を実装します。運営会社向けには、ダッシュボード画面、手数料請求管理画面、設定画面を実装します。

詳細な実装指示は、添付の `implementation_prompt.md` を参照してください。

## 成果物

本プロジェクトの成果物として、以下のドキュメントとファイルを提供します。

| ファイル名 | 説明 |
| :--- | :--- |
| `project_summary.md` | プロジェクト全体の概要をまとめたドキュメント（本ファイル） |
| `functional_requirements.md` | 機能要件定義書 |
| `database_design.md` | データベース設計書（テーブル定義） |
| `implementation_prompt.md` | AI開発者向けの実装指示プロンプト |
| `business_flow.png` | ビジネスフロー図 |

これらのドキュメントを参照しながら、開発を進めてください。

## 次のステップ

本プロジェクトを進めるにあたり、以下のステップで作業を進めることを推奨します。

1. 本ドキュメント（`project_summary.md`）と `functional_requirements.md` を読み、プロジェクト全体の要件を理解する。
2. `database_design.md` を参照し、データベーススキーマを更新する。
3. `implementation_prompt.md` に記載された手順に従い、バックエンドとフロントエンドの実装を進める。
4. 実装完了後、各機能が要件通りに動作するかテストを行う。

不明な点や追加の質問があれば、遠慮なくお問い合わせください。

---

**作成者**: Manus AI  
**作成日**: 2025年10月16日

