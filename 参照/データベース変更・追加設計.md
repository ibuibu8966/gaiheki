# データベース変更・追加設計

## 1. 既存テーブルの変更

### `orders` テーブル

請求書IDを紐付けるために `customer_invoice_id` を追加します。

```prisma
model orders {
  // ... 既存のカラム
  customer_invoice_id Int?      @unique
  customer_invoices   customer_invoices? @relation(fields: [customer_invoice_id], references: [id])
}
```

### `partners` テーブル

加盟店ごとの料金プランを管理するために `fee_plan_id` を追加します。

```prisma
model partners {
  // ... 既存のカラム
  fee_plan_id       Int?
  fee_plans         fee_plans? @relation(fields: [fee_plan_id], references: [id])
  company_invoices  company_invoices[]
}
```

## 2. 新規テーブルの追加

### `customer_invoices` (加盟店→顧客への請求書)

加盟店が顧客に対して発行する請求書を管理します。

```prisma
model customer_invoices {
  id              Int            @id @default(autoincrement())
  invoice_number  String         @unique @db.VarChar(50) // 請求書番号 (例: INV-2025-0001)
  order_id        Int            @unique
  issue_date      DateTime       @db.Date // 発行日
  due_date        DateTime       @db.Date // 支払期日
  total_amount    Int            // 合計金額 (税抜)
  tax_amount      Int            // 消費税額
  grand_total     Int            // 総合計 (税込)
  status          InvoiceStatus  @default(UNPAID) // 請求ステータス
  payment_date    DateTime?      @db.Date // 入金日
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  order           orders         @relation(fields: [order_id], references: [id])
  invoice_items   customer_invoice_items[]
}

model customer_invoice_items {
  id                Int      @id @default(autoincrement())
  invoice_id        Int
  description       String   @db.VarChar(255) // 品目
  quantity          Float    // 数量
  unit              String   @db.VarChar(20)  // 単位
  unit_price        Int      // 単価
  amount            Int      // 金額 (税抜)
  created_at        DateTime @default(now())

  invoice           customer_invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}
```

### `fee_plans` (料金プラン)

運営会社が設定する加盟店向けの料金プランを管理します。

```prisma
model fee_plans {
  id              Int        @id @default(autoincrement())
  name            String     @db.VarChar(100) // プラン名 (例: スタンダードプラン)
  monthly_fee     Int?       // 月額固定料金
  per_order_fee   Int?       // 受注ごとの固定料金
  per_project_fee Int?       // 施工完了ごとの固定料金
  project_fee_rate Float?    // 施工完了ごとの料率 (例: 0.1 = 10%)
  is_default      Boolean    @default(false) // デフォルトプランか
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  partners        partners[]
}
```

### `company_invoices` (運営→加盟店への請求書)

運営会社が加盟店に対して発行するプラットフォーム手数料の請求書を管理します。

```prisma
model company_invoices {
  id              Int            @id @default(autoincrement())
  invoice_number  String         @unique @db.VarChar(50) // 請求書番号 (例: COMP-2025-0001)
  partner_id      Int
  issue_date      DateTime       @db.Date // 発行日
  due_date        DateTime       @db.Date // 支払期日
  billing_period_start DateTime  @db.Date // 請求対象期間(開始)
  billing_period_end   DateTime  @db.Date // 請求対象期間(終了)
  total_amount    Int            // 合計金額 (税抜)
  tax_amount      Int            // 消費税額
  grand_total     Int            // 総合計 (税込)
  status          InvoiceStatus  @default(UNPAID) // 請求ステータス
  payment_date    DateTime?      @db.Date // 入金日
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  partner         partners       @relation(fields: [partner_id], references: [id])
  invoice_items   company_invoice_items[]
}

model company_invoice_items {
  id                Int      @id @default(autoincrement())
  invoice_id        Int
  description       String   @db.VarChar(255) // 品目 (例: 月額利用料, 受注手数料)
  amount            Int      // 金額 (税抜)
  related_order_id  Int?     // 関連受注ID
  created_at        DateTime @default(now())

  invoice           company_invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}
```

### `system_settings` (システム設定)

請求サイクルなどの設定を管理します。

```prisma
model system_settings {
  id              Int      @id @default(autoincrement())
  setting_key     String   @unique @db.VarChar(100)
  setting_value   String   @db.VarChar(255)
  description     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
}
```

## 3. Enumの追加

請求ステータスを管理するためのEnumを追加します。

```prisma
enum InvoiceStatus {
  DRAFT     // 下書き
  UNPAID    // 未払い
  PAID      // 支払い済み
  OVERDUE   // 支払い遅延
  CANCELLED // キャンセル
}
```

